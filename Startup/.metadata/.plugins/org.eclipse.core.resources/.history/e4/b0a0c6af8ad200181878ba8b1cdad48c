# coding=gbk
'''
Created on 2018年10月17日
@author: 钟以琛
'''

from socket import *
from threading import Thread
from code import args

def main():
    # create welcome socket for all requesting clients
    serverPort = 12000
    serverSocket = socket(AF_INET, SOCK_STREAM)
    serverSocket.bind(('', serverPort))
    
    # accepted clients dictionary
    dic = {}
    
    # listen to 'knocking to the welcome door'
    serverSocket.listen(2)
    print('The server is ready to receive...')
    
    while True:
        # create connectionSocket for the single client after accepting
        connectionSocket, addr = serverSocket.accept()
        if (not(dic.__contains__(addr))):
            dic[addr] = connectionSocket
        
        p = Thread(target = msgToUpper, args(connectionSocket))
        p.start()

def msgToUpper(clientSocket):
    while True:
        msgFrmC = clientSocket.recv(1024).decode()
        if (len(msgFrmC) > 0):
            modifiedMessage = msgFrmC.upper()
            print("Msg from client(%s:%s): %s" % (addr[0], addr[1], msgFrmC))
            print('Response: ' + modifiedMessage)
            clientSocket.send(modifiedMessage.encode())
        else:
            break
        clientSocket.close()
